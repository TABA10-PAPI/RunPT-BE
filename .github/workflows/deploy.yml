name: Docker-Based CI/CD for Spring Boot

on:
  push:
    branches: [ "main" ]

# í™˜ê²½ ë³€ìˆ˜ ì •ì˜
env:
  DOCKER_IMAGE_NAME: back-app
  IMAGE_TAG: latest

jobs:
  # 1. ë¹Œë“œ ë° Docker Hubì— ì´ë¯¸ì§€ í‘¸ì‹œ (CI ë‹¨ê³„)
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1.1. CI: Spring Boot JAR íŒŒì¼ ë¹Œë“œ
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Build Spring Boot JAR (back/ë¡œ ì´ë™ ë° ë¹Œë“œ)
        working-directory: ./back
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      # ğŸ’¡ [í•„ìˆ˜ ìˆ˜ì • ë°˜ì˜] JAR íŒŒì¼ì„ 'back/' (ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ë£¨íŠ¸)ë¡œ ì´ë™í•©ë‹ˆë‹¤.
      # Dockerfileì˜ COPY ëª…ë ¹ (COPY back-0.0.1-SNAPSHOT.jar app.jar)ì„ ë§Œì¡±ì‹œí‚¤ê¸° ìœ„í•¨ì…ë‹ˆë‹¤.
      - name: Rename and Move JAR file to Build Context Root
        run: mv ./back/build/libs/*.jar ./back/back-0.0.1-SNAPSHOT.jar
        
      # 1.2. Docker: ë¡œê·¸ì¸ ë° ì´ë¯¸ì§€ ë¹Œë“œ/í‘¸ì‹œ
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and Push Docker Image to Docker Hub
        uses: docker/build-push-action@v5
        with:
          # back/ í´ë”ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ ì§€ì •
          context: ./back 
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          file: ./back/Dockerfile

  # 2. EC2ì— ì ‘ì†í•˜ì—¬ ìµœì‹  Docker ì´ë¯¸ì§€ë¡œ ì»¨í…Œì´ë„ˆ êµì²´ (CD ë‹¨ê³„)
  deploy:
    needs: build_and_push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2 (Docker ì»¨í…Œì´ë„ˆ êµì²´)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            DOCKER_USER=${{ secrets.DOCKER_HUB_USERNAME }}
            IMAGE_NAME=${DOCKER_USER}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            CONTAINER_NAME=runpt-back

            echo "Login to Docker Hub..."
            docker login -u ${DOCKER_USER} -p ${{ secrets.DOCKER_HUB_TOKEN }}
            
            echo "Pulling latest image: ${IMAGE_NAME}"
            docker pull ${IMAGE_NAME}
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
            if [ $(docker ps -a -q -f name=${CONTAINER_NAME}) ]; then
              echo "Stopping and removing existing container..."
              docker stop ${CONTAINER_NAME}
              docker rm ${CONTAINER_NAME}
            fi
            
            # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (DB í™˜ê²½ ë³€ìˆ˜ ì£¼ì…)
            echo "Running new ${CONTAINER_NAME} container with DB Secrets..."
            docker run -d --name ${CONTAINER_NAME} \
              -p 127.0.0.1:8080:8080 \
              -e DB_END_POINT="${{ secrets.DB_END_POINT }}" \
              -e DB_USER="${{ secrets.DB_USER }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              --restart unless-stopped \
              ${IMAGE_NAME}
            
            echo "ğŸ‰ Deployment completed!"