name: Docker-Based CI/CD for Spring Boot

on:
  push:
    branches: [ "main" ] # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰

# í™˜ê²½ ë³€ìˆ˜ ì •ì˜
env:
  DOCKER_IMAGE_NAME: back-app
  IMAGE_TAG: latest

jobs:
  # 1. ë¹Œë“œ ë° Docker Hubì— ì´ë¯¸ì§€ í‘¸ì‹œ (CI ë‹¨ê³„)
  build_and_push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1.1. CI: Spring Boot JAR íŒŒì¼ ë¹Œë“œ
      - name: Set up JDK 21
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Build Spring Boot JAR (back/ë¡œ ì´ë™ ë° ë¹Œë“œ)
        working-directory: ./back
        run: |
          chmod +x gradlew
          # í…ŒìŠ¤íŠ¸ëŠ” ê±´ë„ˆë›°ê³  clean build ì‹¤í–‰
          ./gradlew clean build -x test

      # ğŸ’¡ [í•µì‹¬ ìˆ˜ì • ë¶€ë¶„] ì‹¤í–‰ ê°€ëŠ¥í•œ JAR íŒŒì¼(bootJar ê²°ê³¼ë¬¼)ë§Œ ì°¾ì•„ ì´ë™ì‹œí‚µë‹ˆë‹¤.
      - name: Locate and Move Executable JAR file
        run: |
          # *-plain.jarì´ ì•„ë‹Œ, ì‹¤í–‰ ê°€ëŠ¥í•œ JAR íŒŒì¼ì„ ì°¾ìŠµë‹ˆë‹¤. 
          # ì°¾ì§€ ëª»í•˜ë©´ ì—ëŸ¬ ë°œìƒ í›„ ì¢…ë£Œë©ë‹ˆë‹¤.
          TARGET_JAR=$(find ./back/build/libs -maxdepth 1 -name "*.jar" ! -name "*-plain.jar" -print -quit)
          
          echo "Discovered TARGET JAR file: $TARGET_JAR"
          
          if [ -z "$TARGET_JAR" ]; then
              echo "Error: Could not find the executable JAR file in ./back/build/libs/."
              echo "Please check build.gradle for 'org.springframework.boot' plugin."
              ls -l ./back/build/libs/ # ë””ë²„ê¹…ì„ ìœ„í•´ ë¹Œë“œëœ íŒŒì¼ ëª©ë¡ ì¶œë ¥
              exit 1
          fi
          
          # ì°¾ì€ íŒŒì¼ì„ Dockerfileì´ ê¸°ëŒ€í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ./back/ í´ë”ë¡œ ì´ë™
          mv "$TARGET_JAR" ./back/back-0.0.1-SNAPSHOT.jar
          
          echo "Move complete. Listing contents of ./back/ for verification:"
          ls -l ./back/ # ì´ë™ í™•ì¸ìš© ë””ë²„ê¹… ëª…ë ¹

      # 1.2. Docker: ë¡œê·¸ì¸ ë° ì´ë¯¸ì§€ ë¹Œë“œ/í‘¸ì‹œ
      - name: Docker Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and Push Docker Image to Docker Hub
        uses: docker/build-push-action@v5
        with:
          # Dockerfileì´ ìˆëŠ” ./back í´ë”ë¥¼ ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ë¡œ ì§€ì •
          context: ./back 
          push: true
          tags: ${{ secrets.DOCKER_HUB_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
          file: ./back/Dockerfile

  # 2. EC2ì— ì ‘ì†í•˜ì—¬ ìµœì‹  Docker ì´ë¯¸ì§€ë¡œ ì»¨í…Œì´ë„ˆ êµì²´ (CD ë‹¨ê³„)
  deploy:
    needs: build_and_push # 1ë²ˆ Jobì´ ì„±ê³µí•´ì•¼ë§Œ ì‹¤í–‰
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2 (Docker ì»¨í…Œì´ë„ˆ êµì²´)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            DOCKER_USER=${{ secrets.DOCKER_HUB_USERNAME }}
            IMAGE_NAME=${DOCKER_USER}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            CONTAINER_NAME=runpt-back

            echo "Login to Docker Hub..."
            docker login -u ${DOCKER_USER} -p ${{ secrets.DOCKER_HUB_TOKEN }}
            
            echo "Pulling latest image: ${IMAGE_NAME}"
            docker pull ${IMAGE_NAME}
            
            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ì‚­ì œ
            if [ $(docker ps -a -q -f name=${CONTAINER_NAME}) ]; then
              echo "Stopping and removing existing container..."
              docker stop ${CONTAINER_NAME}
              docker rm ${CONTAINER_NAME}
            fi
            
            # ìƒˆ ì´ë¯¸ì§€ë¡œ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ (DB í™˜ê²½ ë³€ìˆ˜ ì•ˆì „í•˜ê²Œ ì£¼ì…)
            echo "Running new ${CONTAINER_NAME} container with DB Secrets..."
            # -e ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ GitHub Secretsì— ì €ì¥ëœ DB ì •ë³´ë¥¼ ì „ë‹¬
            docker run -d --name ${CONTAINER_NAME} \
              -p 127.0.0.1:8080:8080 \
              -e DB_END_POINT="${{ secrets.DB_END_POINT }}" \
              -e DB_USER="${{ secrets.DB_USER }}" \
              -e DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
              --restart unless-stopped \
              ${IMAGE_NAME}
            
            echo "ğŸ‰ Deployment completed!"