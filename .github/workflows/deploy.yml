name: Deploy Spring Boot to EC2 (Ubuntu)


on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. JDK ì„¤ì¹˜
      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          java-version: '21'
          distribution: 'temurin'

      # 3. Spring Boot ë¹Œë“œ
      - name: Build Spring Boot Project
        working-directory: ./back
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test

      # 4. EC2ì— JAR ë° ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡ + ì‹¤í–‰
      - name: Deploy to EC2
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USER: ${{ secrets.EC2_USER }}
          PRIVATE_KEY: ${{ secrets.EC2_KEY }}
        run: |
          # ğŸ” SSH Key ìƒì„±
          echo "$PRIVATE_KEY" > key.pem
          chmod 600 key.pem

          # ğŸŸ¢ EC2 ì—°ê²° í™•ì¸
          ssh -o StrictHostKeyChecking=no -i key.pem $USER@$HOST "echo 'Connected to EC2'"

          # ğŸ“¦ íŒŒì¼ ì „ì†¡ (JAR + restart.sh)
          scp -o StrictHostKeyChecking=no -i key.pem back/build/libs/back-0.0.1-SNAPSHOT.jar $USER@$HOST:/home/app/
          scp -o StrictHostKeyChecking=no -i key.pem back/script/restart.sh $USER@$HOST:/home/app/

          # ğŸ”§ restart.sh ì‹¤í–‰ ê°€ëŠ¥ ê¶Œí•œ ë¶€ì—¬
          ssh -o StrictHostKeyChecking=no -i key.pem $USER@$HOST "chmod +x /home/app/restart.sh"

          # ğŸš€ ì„œë²„ ì¬ì‹œì‘ ì‹¤í–‰
          ssh -o StrictHostKeyChecking=no -i key.pem $USER@$HOST "/home/app/restart.sh"
